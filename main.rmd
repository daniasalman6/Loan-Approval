---
title: "Data Science Project - Loan Approval"
author: "Alex Biuckians, Armin Soroosh, Dania Salman, Kaipu Liu"
output:
  html_document:
    code_folding: hide
    number_sections: false
    theme: journal
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r init, include=FALSE}
# some of common options (and the defaults) are: 
# include=T, eval=T, echo=T, results='hide'/'asis'/'markup',..., collapse=F, warning=T, message=T, error=T, cache=T, fig.width=6, fig.height=4, fig.dim=c(6,4) #inches, fig.align='left'/'center','right', 
library(ezids)
# knitr::opts_chunk$set(warning = F, results = "markup", message = F)
#knitr::opts_chunk$set(warning = F, results="hide", message = F)
knitr::opts_chunk$set(warning = F, message = F)
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
# ‘scipen’: integer. A penalty to be applied when deciding to print numeric values in fixed or exponential notation.  Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than ‘scipen’ digits wider.
# use scipen=999 to prevent scientific notation at all times
```

## Loading the Dataset
```{r read_dataset, echo=TRUE}
# reading dataset
loan_df <- data.frame(read.csv("loan_approval_dataset.csv"))
```

```{r explore_dataset, echo=TRUE}
# exploring dataset
str(loan_df)
```
The dataset has **4269 observations** with **13 variables**

## Data Cleaning & Summary

### subsetting data and converting categorical variables to factor
Removing loan_id column since it only serves as a unique identifier and does not contribute to the analysis. Furthermore, converting several numeric variables into factors, as they represent categorical information rather than continuous numerical values.
```{r data_cleaning, echo=TRUE}
loan_df <- subset(loan_df, select = -c(loan_id))

# converting the numeric variables to factor variables
loan_df$no_of_dependents = as.factor(loan_df$no_of_dependents)
loan_df$education = as.factor(loan_df$education)
loan_df$self_employed = as.factor(loan_df$self_employed)
loan_df$loan_status = as.factor(loan_df$loan_status)
str(loan_df)
```
After conversion, the dataset contains four categorical variables:

- **no_of_dependents:** Number of dependents the applicant has (`6` categories: `0`, `1`, `2`, `3`, `4`, `5`)

- **education:** Applicant’s level of education (`2` categories: `Graduate`, `Not Graduate`)

- **self_employed:** Whether the applicant is self-employed (`2` categories: `Yes`, `No`)

- **loan_status:** Loan approval status — this is the target variable (`2` categories: `Approved`, `Rejected`)

### Finding NA values
```{r, echo=TRUE}
sum(is.na(loan_df))
```
There are no NA values in the data set

### Summary of the dataset
```{r echo=TRUE}
summary(loan_df)
```
Overall, the dataset appears well-structured and balanced. **Categorical variables** such as `education`, `self_employment`, and `loan_status` show nearly **even distributions** across their categories. Most **numerical variables** fall within reasonable ranges, with average loan terms around `11 years` and CIBIL scores centered near `600`, both indicating realistic applicant profiles. However, some financial variables like income, loan amount, and asset values show wide variation and possible outliers. In particular, the presence of negative values in `residential_assets_value` points to potential data quality issues that will need correction before exploration or testing.

### Cleaning up negative values
Checking the number of rows that have negative values for `residential_assets_value` column
```{r echo=TRUE}
sum(loan_df$residential_assets_value < 0)
```
There are `28` entries with negative values.

### Removing entries with negative values
```{r echo=TRUE}
loan_df <- loan_df[loan_df$residential_assets_value >= 0, ]
str(loan_df)
summary(loan_df)
```
After filtering out the rows with negative values, the dataset now has `4,241 observations`. The distributions across all variables look almost identical to before, showing that this cleaning step didn’t affect the data overall.

## Exploratory Data Analysis

### Does education level affect loan approval?
```{r Q1, echo=TRUE}
edu_table <- table(loan_df$education, loan_df$loan_status)
print(edu_table)

edu_chi <- chisq.test(edu_table)
print(edu_chi)

ggplot(loan_df, aes(x = education, fill = loan_status)) +
  geom_bar(position = "fill") +
  labs(title = "Loan Approval Rate by Education Level",
       y = "Proportion",
       x = "Education Level") +
  theme_minimal()
```

Statistical Analysis Breakdown

Contingency Table
The raw counts show a very similar distribution of approvals and rejections across both groups.Graduate applicants had 1,339 approvals and 805 rejections.Not Graduate applicants had 1,317 approvals and 808 rejections.This similarity suggests the approval rates are nearly identical: ~62.4% for graduate and 62% for non-graduate.

Chi-Square Test
The test statistic is .083958. This indicates that the data is close to what you would expect.
The p-value is .772. It is much larger than the standard significance level of .05, we fail to reject to reject the null hypothesis. This is the formal statistical confirmation that there is no significant association between an applicant's education level and their loan status.

Proportion visualization(The bar chart)
The stacked bar chart, which shows the proportion of approvals within each education level, visually confirms the statistical finding. The height of the "Approved" segment is virtually the same for both Graduate and Not Graduate bars, indicating that an individual's chance of approval is not meaningfully affected by their educational background.

### Do people with higher asset values tend to get approved more often?
```{r Q2, echo=TRUE}
#Summary of asset values by loan status
loan_df %>%
  group_by(loan_status) %>%
  summarise(across(c(residential_assets_value, commercial_assets_value,
                     luxury_assets_value, bank_asset_value),
                   list(mean = mean, median = median), .names = "{.col}_{.fn}"))

# Independent samples t-tests for each asset type
t.test(residential_assets_value ~ loan_status, data = loan_df)
t.test(commercial_assets_value ~ loan_status, data = loan_df)
t.test(luxury_assets_value ~ loan_status, data = loan_df)
t.test(bank_asset_value ~ loan_status, data = loan_df)
```
These are Welch Two Sample t-test to determine if there is a statistically significant difference in the average asset values between applications whose loans were approved versus those whose loans were rejected. The t-test results demonstrate that the four asset categories consistently show no statistically significant difference between the means of the Approved and Rejected groups. The residential assets demonstrate a slightly higher mean value for the rejected loans at roughly 7.592 million dollars than for approved loans at 7.399 million. However, the p-value of .3481 confirms that the difference is not statistically significant. The mean value of approved loans for commercial assets is slightly higher at 5.001 million dollars compared to 4.926 million dollars. The p-value of .591 confirms the difference is not statistically significant. The mean value of rejected loans for luxury assets is slightly higher at 15.306 million dollars compared to the mean in the group approved at 15.016 million dollars. The p-value of .3107 shows this difference is not statistically significant. For the bank assets, the mean value of rejected loans is slightly higher at 5.004 million dollars compared to the 4.959 million dollar mean for the approved. However, the p-value .656 is not statistically significant. 

#Shapiro test
```{r}

shapiro_residential <- shapiro.test(loan_df$residential_assets_value)
shapiro_commercial  <- shapiro.test(loan_df$commercial_assets_value)
shapiro_luxury      <- shapiro.test(loan_df$luxury_assets_value)
shapiro_bank_assets<-shapiro.test(loan_df$bank_asset_value)


cat("p-value (Residential Assets):", shapiro_residential$p.value, "\n")
cat("p-value (Commercial Assets):", shapiro_commercial$p.value, "\n")
cat("p-value (Luxury Assets):", shapiro_luxury$p.value, "\n")
cat("p-value (Bank Assets):", shapiro_bank_assets$p.value, "\n")

qqnorm(loan_df$residential_assets_value, 
       main = "Q-Q Plot of Residential Assets Value")
qqline(loan_df$residential_assets_value, col = "red", lwd = 2)
qqnorm(loan_df$commercial_assets_value, 
       main = "Q-Q Plot of Commercial Assets Value")
qqline(loan_df$commercial_assets_value, col = "red", lwd = 2)
qqnorm(loan_df$luxury_assets_value, 
       main = "Q-Q Plot of Luxury Assets Value")
qqline(loan_df$luxury_assets_value, col = "red", lwd = 2)
qqnorm(loan_df$bank_asset_value, 
       main = "Q-Q Plot of Bank Assets Value")
qqline(loan_df$bank_asset_value, col = "red", lwd = 2)
par(mfrow = c(2, 2), mar = c(4, 4, 2, 1))

# 1. Residential Assets Histogram
hist(loan_df$residential_assets_value,
     main = "Histogram of Residential Assets Value",
     xlab = "Residential Assets Value",
     col = "lightblue",
     border = "black")

# 2. Commercial Assets Histogram
hist(loan_df$commercial_assets_value,
     main = "Histogram of Commercial Assets Value",
     xlab = "Commercial Assets Value",
     col = "lightgreen",
     border = "black")

# 3. Luxury Assets Histogram
hist(loan_df$luxury_assets_value,
     main = "Histogram of Luxury Assets Value",
     xlab = "Luxury Assets Value",
     col = "pink",
     border = "black")

# 4. Bank Assets Histogram
hist(loan_df$bank_asset_value,
     main = "Histogram of Bank Assets Value",
     xlab = "Bank Assets Value",
     col = "salmon",
     border = "black")

# Reset plotting layout to default (1 plot per screen) after generation
par(mfrow = c(1, 1))
```
These tests all see if those with higher assets are approved compared to those who do not Since every p-value is less than the significant level of .05, we reject the null hypothesis and expect those with higher assets to get approved. All the histograms are skewed to the right. This means that most assets are valued at the low end, and extremely high values are rare. The Q-Q plot for the residential assets shows that the points strongly deviate from the line, particularly at the upper end, which is the high asset values. This means that it is not normally distributed. The commercial assets show a similar to residential assets, with a significant upward curve away from the diagonal. This is not normally distributed. The Luxury Asset Q-Q plots shows the same upward curving shape, which means it is not normally distributed. The Q-Q plot for the Bank Asset Value shows a deviation from the line, which makes it not normally distributed. 


### Is there a significant difference in average income between approved and rejected applicants?
```{r Q3, echo=TRUE}
# Group by loan approval status and extract their annual income data
approved_income <- loan_df$income_annum[loan_df$loan_status == " Approved"]
rejected_income <- loan_df$income_annum[loan_df$loan_status == " Rejected"]
# Calculate each group's mean annual income
mean_approved <- mean(approved_income, na.rm = TRUE)
mean_rejected <- mean(rejected_income, na.rm = TRUE)
cat("Mean annual income of Approved group:", mean_approved, "\n")
cat("Mean annual income of Rejected group:", mean_rejected, "\n")

# Conduct hypothesis testing
t_test_result <- t.test(approved_income, rejected_income)
print("t-test result：")
print(t_test_result)
# Draw the histogram
hist(approved_income, 
     col = "#8DD9C1",
     main = "The distribution of annual income", 
     xlab = "Annual income", 
     ylab = "Frequency",
     breaks = 30)
hist(rejected_income, 
     col = "#12362A", 
     breaks = 30,
     add = TRUE)
legend("topright", 
       legend = c("Approved", "Rejected"), 
       fill = c("#8DD9C1", "#12362A")) 

```
The average annual income of the approved group is `5,025,904`, while that of the rejected group is `5,113,825`, resulting in a mean difference of approximately `87,921`. To determine whether this difference is statistically significant, a Welch Two-Sample t-test was performed.

- **Null Hypothesis (H₀):** There is no significant difference in the average annual income between approved and rejected applicants.

- **Alternative Hypothesis (H₁):** There is a significant difference in the average annual income between approved and rejected applicants.

The test results showed a **t-value** of `-1` and a **p-value** of `0.3`, which is much greater than the significance level `(α = 0.05)`. This indicates that the difference between the two means is **not statistically significant**. The `95%` confidence interval for the mean difference is `[-260,821, 84,978]`, which includes zero; further supporting the conclusion that the average incomes of the two groups may be equal.

A histogram comparing the income distributions of both groups also shows similar shapes, reinforcing that there is no clear distinction between them.

In conclusion, income alone does not appear to be a strong predictor of loan approval in this dataset.



### Is there a correlation between applicant's annual income and loan amount requested?
```{r Q4, echo=TRUE}
annual_income <- loan_df$income_annum
loan_amount <- loan_df$loan_amount

# Check whether normal distribution
shapiro_income <- shapiro.test(annual_income)
shapiro_loan <- shapiro.test(loan_amount)
cat("p-value of annual income：", shapiro_income$p.value, "\n")
cat("p-value of loan amount：", shapiro_loan$p.value, "\n")
# Choose the correlation coefficient
if (shapiro_income$p.value > 0.05 & shapiro_loan$p.value > 0.05) {
  cor_result <- cor.test(annual_income, loan_amount, method = "pearson")
  cat("Pearson result：\n")
} else {
  cor_result <- cor.test(annual_income, loan_amount, method = "spearman")
  cat("Spearman reslut：\n")
}
print(cor_result)

# Draw the plot
plot(
  x = annual_income,
  y = loan_amount,
  main = "Annual Income vs. Loan Amount Requested",
  xlab = "Annual Income",
  ylab = "Loan Amount Requested",
  pch = 16,
  col = "#FFC412",
  cex = 0.8
)
# Add the regression line
abline(lm(loan_amount ~ annual_income), col = "red", lwd = 2)
legend("topleft", 
       legend = "regression line", 
       col = "red", 
       lty = 1, 
       lwd = 2)




```
The normality of the data for both annual income and loan amount was tested, and since they did not follow a normal distribution, the Spearman correlation coefficient was used. The resulting `rho = 0.941` indicates a very strong positive correlation between the two variables, with a `p-value < 0.05`, confirming that the relationship is statistically significant.

The scatter plot further supports this finding, showing a clear upward trend—loan amounts increase as annual income increases. The red regression line visually emphasizes this strong positive relationship.

In conclusion, Annual income is a key factor influencing the loan amount requested, as the two are strongly and positively correlated.

### Is there a significant difference in average CIBIL scores between approved and rejected applicants?
```{r Q5, echo=TRUE}
library(ggplot2)
#CIBIL score frequency distribution
hist(loan_df$cibil_score, main = "Frequency Distribution of CIBIL Scores", xlab = "CIBIL Score", ylab = "Frequency", breaks = 15, col = "#197571")

#CIBIL score frequency distribution
loan_df$loan_status <- factor(trimws(loan_df$loan_status))
ggplot(loan_df, aes(x = cibil_score, fill = loan_status)) +
  geom_histogram(binwidth = 50, color = "white", alpha = 0.8) +
  facet_wrap(~ loan_status, scales = "free_y") +
  labs(title = "CIBIL Score Distribution by Loan Status", x = "CIBIL Score", y = "Frequency", fill = "Loan Status") + scale_fill_manual(values = c("Approved" = "#197571", "Rejected" = "#FFCF85"))

#CIBIL score frequency box chart
ggplot(loan_df, aes(x = loan_status, y = cibil_score, fill = loan_status)) +
  geom_boxplot() +
  labs(title = "CIBIL Score Distribution by Loan Status", x = "Loan Status", y = "CIBIL Score") +
  scale_fill_manual(values = c("Approved" = "#197571", "Rejected" = "#FFCF85"))

#t-test
t.test(cibil_score ~ loan_status, data = loan_df)

```
The overall CIBIL score frequency distribution shows no apparent outliers. The individual distributions for approved and rejected loans show a few outliers, but it is not necessary to remove them. Even though the outliers are dragging the two means closer to each other, the means are still significantly different even when including them in the t-test.

There is a significant difference in CIBIL scores between approved and rejected applicants because the p-value, `2e-16`, is much lower than the standard alpha threshold of `0.05`. This allows us to reject the null hypothesis that the two means of approved and rejected applicants are **equal**.

### For rejected loans, is there a significant difference in the mean CIBIL score between applicants with shorter loan term loans (<=10 years) versus longer term loans(>10 years)?
```{r Q6, echo=TRUE}

#created subsets for shorter and longer loans then ran t-test
rejected_shorter <- subset(loan_df, trimws(loan_status) == "Rejected" & loan_term <= 10)
rejected_longer <- subset(loan_df, trimws(loan_status) == "Rejected" & loan_term > 10)

#Overall loan term frequency distribution
ggplot(loan_df, aes(x = factor(loan_term))) + geom_bar(fill = "#7B3D91") + labs(title = "Frequency Distribution of Loan Terms", x = "Loan Term (Years)", y = "Frequency")

#boxplot
boxplot(
  rejected_shorter$cibil_score,
  rejected_longer$cibil_score,
  names = c("Shorter (<= 10 yrs)", "Longer (> 10 yrs)"),
  main = "CIBIL Score Distribution for Rejected Loans",
  ylab = "CIBIL Score",
  xlab = "Loan Term Group",
  col = c("#A769C2", "#87BDCC")  # add your custom colors here
)
#removing outliers
removeOutliers <- function(x) {Q1 <- quantile(x, 0.25)
Q3 <- quantile(x, 0.75);
IQR_val <- Q3 - Q1;
lower_bound <- Q1 - (1.5 * IQR_val);
upper_bound <- Q3 + (1.5 * IQR_val);
  
return(x[x >= lower_bound & x <= upper_bound]);}

cleaned_shorter_cibil <- removeOutliers(rejected_shorter$cibil_score)
cleaned_longer_cibil <- removeOutliers(rejected_longer$cibil_score)

t.test(rejected_shorter$cibil_score, rejected_longer$cibil_score)
t.test(cleaned_shorter_cibil, cleaned_longer_cibil)

```

The overall loan terms frequency distribution shows no apparent outliers however there are a few in the shorter and longer loan term groups. Having this said, even when removing these outliers there no significant differences found between the two groups and their respective CIBIL scores.

There is not a significant difference in CIBIL scores between shorter `(<= 10 years)` and longer `(>10 years)` term loans within the rejected group of applicants because the **p-value**, `1`, is much higher than the standard alpha threshold of `0.05`. This allows us to accept the null hypothesis that the two means of shorter and longer term loans of rejected applicants are equal.

### Is there a correlation between the CIBIL Score and the Loan Term among those whose loans are approved?  
```{r Q7, echo=TRUE}

#correlation coefficient
corr_r <- cor(loan_df[trimws(loan_df$loan_status) == "Approved", "cibil_score"], loan_df[trimws(loan_df$loan_status) == "Approved", "loan_term"], method = "pearson")

#correlation test
cor.test(loan_df[trimws(loan_df$loan_status) == "Approved", "cibil_score"], loan_df[trimws(loan_df$loan_status) == "Approved", "loan_term"], method = "pearson")

#scatter plot
ggplot(subset(loan_df, trimws(loan_status) == "Approved"), aes(x = loan_term, y = cibil_score)) + geom_point(alpha = 0.4, color = "#AAE5D8") + geom_smooth(method = "lm", se = FALSE, color = "#061411") + labs(title = "CIBIL Score vs. Loan Term for Approved Loans", x = "Loan Term (Years)", y = "CIBIL Score")

```

The correlation coefficient of `0.21` shows a weak but positive relationship where approved candidates with higher CIBIL scores have a slightly higher tendency to approved for longer loan terms. And the p-value is very small, `2e-16`, meaning that the correlation coefficient is unlikely due to chance.

### Does self-employment status affect loan approval?
```{r Q8, echo=TRUE}
ggplot(loan_df, aes(x = self_employed, fill = loan_status)) +
  geom_bar(position = "dodge") +
  labs(
    title = "Loan Approval by self employment status",
    x = "self employment status",
    y = "Number of Applicants"
  ) +
  scale_fill_manual(values = c("Approved" = "#F2764E", Rejected = "#FAF487")) +
  theme_minimal()
```
Approval rates are nearly **identical** for self-employed and non self-employed applicants, suggesting self-employment likely doesn’t affect loan approval. A Chi-square test will confirm this statistically.

```{r, echo=TRUE}
contable <- table(loan_df$self_employed, loan_df$loan_status)
chisq.test(contable)
```
The Chi-square test (`p = 1`) also shows no significant association between self-employment status and loan approval. This confirms that self-employment does not affect the likelihood of loan approval in this dataset.

### Does the number of dependents affect approval of loans?
```{r Q9, echo=TRUE}
ggplot(loan_df, aes(x = no_of_dependents, fill = loan_status)) +
  geom_bar(position = "dodge") +
  labs(
    title = "Loan Approval by Number of Dependents",
    x = "Number of Dependents",
    y = "Number of Applicants"
  ) +
  scale_fill_manual(values = c("Approved" = "#0D0942", "Rejected" = "#C4C0F6")) +
  theme_minimal()
```
The bar chart shows that approval and rejection counts are fairly similar across all dependent categories, with no noticeable trend suggesting that the number of dependents strongly influences loan approval outcomes. While minor variations exist, the approval rate appears consistent across groups, indicating that loan approval is likely independent of the number of dependents. A Chi-square test will confirm this statistically.

```{r, echo=TRUE}
contable <- table(loan_df$no_of_dependents, loan_df$loan_status)
chisq.test(contable)
```
The Chi-square test (`p = 0.8`) also shows no significant association between no_of_dependents and loan approval. This confirms that no_of_dependents does not affect the likelihood of loan approval in this dataset.

### Does requested loan term affect approval?
```{r Q10, echo=TRUE}
ggplot(loan_df, aes(x = loan_status, y = loan_term, fill = loan_status)) +
  geom_boxplot(alpha = 0.6) +
  labs(
    title = "Loan Term by Loan Approval Status",
    x = "Loan Status",
    y = "Loan Term (Years)"
  ) +
  scale_fill_manual(values = c("Approved" = "#98C25F", "Rejected" = "#EB3BA7")) +
  theme_minimal()
```
The boxplot shows that approved loans have a **wider range** of terms, including very short loans, while rejected loans generally have longer terms. The median loan term for approved loans is `10 years`, compared to `12 years` for rejected loans, indicating that rejected loans tend to have slightly longer terms


```{r, echo=TRUE}
t.test(loan_term ~ loan_status, data = loan_df)
```
The two-sample t-test indicates a significant difference in means (`p < 0.05`), with approved loans having a shorter average term (`10.4 years`) than rejected loans (`11.7 years`). The `95%` confidence interval for the mean difference is `-1.69 to -1.01` (the interval doesn't have 0), confirming that approved loans tend to have shorter terms.
